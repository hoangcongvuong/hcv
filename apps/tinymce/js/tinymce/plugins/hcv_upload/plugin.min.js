tinymce.PluginManager.add('hcv_upload', function(editor, url) {
    // Add a button that opens a window
    var hcv = 10;
    editor.addButton('hcv_upload', {
        text: 'Upload Image',
        icon: 'image',
        onclick: function() {
            // Open window
            editor.windowManager.open({
                width: 950,
                height: 500,
                resizable: true,
                id: 'vuong',
                url: url + '/index.php?multi_select=1',
                title: 'Upload Frame',
                

                buttons: [{
					text: 'Submit',
					onclick: 'submit'
				},
                {
                    text: 'Cancel',
					onclick: 'close'
				}
                ],
                
                
                onsubmit: function(e) {
                    // Insert content when the window form is submitted
                    
                    var iframe = document.getElementsByTagName('iframe')[0];
                    var doc = iframe.contentWindow.document;
                    var br_tag = false;
                    $("iframe").contents().find("#insert_br_tag").each(function(){
                        if($(this).is(":checked")) br_tag = true;
                        
                    });
                    
                    $("iframe").contents().find(".box").each(function(){
                        var src;
                        $(this).find("img").each(function(){
                            src = $(this).attr("src");
                        })
                        if($(this).hasClass("active"))
                        {
                            var atrribute = '';
                            var align = '';
                            $(this).find('.title').each(function(){
                                atrribute += " title='" + $(this).val() + "'"
                            });
                            
                            $(this).find('.alt').each(function(){
                                atrribute += " alt='" + $(this).val() + "'"
                            });
                            
                            $(this).find('.align').each(function(){
                                align += $(this).val();
                            });
                            
                            if(br_tag) editor.insertContent("<p><img src='" + src + "'" + atrribute + "  class='align-" + align + " /><p>");                             
                            else editor.insertContent("<img src='" + src + "'" + atrribute + " class='align-" + align + "' />");
                        }
                        
                    });
                    
                    $("iframe").contents().find("#insert_by_link_form").each(function(){
                        var atrribute = '';
                        var src;
                        $(this).find("#link_insert").each(function(){
                            src = $(this).val();
                        })
                        
                        $(this).find('.title').each(function(){
                            atrribute += " title='" + $(this).val() + "'"
                        });
                        
                        $(this).find('.alt').each(function(){
                            atrribute += " alt='" + $(this).val() + "'"
                        });
                        
                         if(br_tag) editor.insertContent("<p><img src='" + src + "'" + atrribute + " /><p>");                             
                         else editor.insertContent("<img src='" + src + "'" + atrribute + " />");
                    });                 

                    //editor.windowManager.close();
                }
            });
        }
    });

    // Adds a menu item to the tools menu
    editor.addMenuItem('example', {
        text: 'Example plugin',
        context: 'tools',
        onclick: function() {
            // Open window with a specific url
            editor.windowManager.open({
                title: 'TinyMCE site',
                url: 'http://www.tinymce.com',
                width: 800,
                height: 600,
                buttons: [{
                    text: 'Close',
                    onclick: 'close'
                }]
            });
        }
    });
});